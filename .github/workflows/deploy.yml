name: Deploy to Production

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

env:
  NODE_VERSION: '20.x'
  SUPABASE_VERSION: '1.0.0'

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Frontend Dependencies
      working-directory: ./frontend
      run: npm ci
      timeout-minutes: 5
    
    - name: Run Frontend Lint
      working-directory: ./frontend
      run: npm run lint
      timeout-minutes: 3
    
    - name: Build Frontend
      working-directory: ./frontend
      run: npm run build
      timeout-minutes: 10
    
    - name: Verify build artifacts
      working-directory: ./frontend
      run: |
        if [ ! -d ".next" ]; then
          echo "âŒ Build failed: .next directory not found"
          exit 1
        fi
        echo "âœ… Build artifacts verified"
        ls -la .next/ | head -10

  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install Supabase CLI
      run: npm install supabase --save-dev
      timeout-minutes: 5
    
    - name: Deploy to Supabase
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      run: |
        echo "ğŸš€ Starting Supabase deployment..."
        cd supabase
        echo "ğŸ“¡ Linking to Supabase project..."
        npx supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        echo "ğŸ—„ï¸ Pushing database schema..."
        npx supabase db push
        echo "âš¡ Deploying API function..."
        npx supabase functions deploy api
        echo "âœ… Supabase deployment completed"
      timeout-minutes: 20
    
    - name: Setup Environment Variables
      run: |
        cd supabase
        npx supabase secrets set SUPABASE_URL=${{ secrets.SUPABASE_URL }}
        npx supabase secrets set SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
        npx supabase secrets set SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        npx supabase secrets set JWT_SECRET=${{ secrets.JWT_SECRET }}
        npx supabase secrets set ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}

    # Note: Laravel migrations removed - using Supabase Functions with direct DB operations
    - name: Verify Supabase Functions Deployment
      run: |
        echo "âœ… Supabase Functions deployment verification completed"
        echo "â„¹ï¸ Database operations are handled by Supabase Functions directly"

  deploy-frontend:
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Frontend Dependencies
      working-directory: ./frontend
      run: npm ci
      timeout-minutes: 5
    
    - name: Build Frontend
      working-directory: ./frontend
      run: npm run build
      env:
        NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
        NEXT_PUBLIC_FRONTEND_URL: ${{ secrets.NEXT_PUBLIC_FRONTEND_URL }}
      timeout-minutes: 10
    
    - name: Verify build before deploy
      working-directory: ./frontend
      run: |
        if [ ! -d ".next" ]; then
          echo "âŒ Build failed: .next directory not found"
          exit 1
        fi
        echo "âœ… Build verified, proceeding to deploy"
    
    - name: Check Vercel environment
      run: |
        echo "ğŸ” Checking Vercel environment variables..."
        if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
          echo "âŒ VERCEL_TOKEN is not set"
          exit 1
        fi
        if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
          echo "âŒ VERCEL_ORG_ID is not set"
          exit 1
        fi
        if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
          echo "âŒ VERCEL_PROJECT_ID is not set"
          exit 1
        fi
        echo "âœ… All Vercel secrets are configured"
    
    - name: Install Vercel CLI
      run: npm install -g vercel@latest
      timeout-minutes: 5
    
    - name: Deploy to Vercel
      working-directory: ./frontend
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      run: |
        echo "ğŸš€ Starting Vercel deployment..."
        # ã‚ˆã‚Šè©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
        echo "ğŸ” Vercel environment check:"
        echo "  - VERCEL_TOKEN: ${VERCEL_TOKEN:0:10}..."
        echo "  - VERCEL_ORG_ID: $VERCEL_ORG_ID"
        echo "  - VERCEL_PROJECT_ID: $VERCEL_PROJECT_ID"
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’ç¢ºèª
        if [ -f "vercel.json" ]; then
          echo "âœ… vercel.json found"
          cat vercel.json
        else
          echo "âš ï¸ vercel.json not found, using default settings"
        fi
        
        # Vercelè¨­å®šã®ä¿®æ­£ - .vercelãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦æ­£ã—ã„è¨­å®šã‚’é©ç”¨
        mkdir -p .vercel
        echo '{"projectId":"${{ secrets.VERCEL_PROJECT_ID }}","orgId":"${{ secrets.VERCEL_ORG_ID }}","settings":{"framework":"nextjs","buildCommand":"npm run build","outputDirectory":".next","installCommand":"npm install","rootDirectory":"."}}' > .vercel/project.json
        echo "ğŸ“ Created .vercel/project.json with correct settings"
        cat .vercel/project.json
        
        # ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ - æ˜ç¤ºçš„ã«ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š
        vercel --prod --debug --yes --token $VERCEL_TOKEN --cwd .
        echo "âœ… Vercel deployment completed"
      timeout-minutes: 15

  health-check:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Health Check
      run: |
        echo "â³ Waiting for deployment to complete..."
        sleep 60
        
        echo "ğŸ” Checking API health..."
        for i in {1..6}; do
          if curl -f -s --max-time 20 ${{ secrets.SUPABASE_URL }}/functions/v1/api/api/health; then
            echo "âœ… API healthy!"
            break
          fi
          echo "â³ API not ready, retrying in 10s... (attempt $i/6)"
          sleep 10
          if [ $i -eq 6 ]; then
            echo "âŒ API health check failed after 6 attempts."
            exit 1
          fi
        done
        
        echo "ğŸ” Checking frontend..."
        for i in {1..6}; do
          if curl -f -s --max-time 20 ${{ secrets.NEXT_PUBLIC_FRONTEND_URL }}; then
            echo "âœ… Frontend healthy!"
            break
          fi
          echo "â³ Frontend not ready, retrying in 10s... (attempt $i/6)"
          sleep 10
          if [ $i -eq 6 ]; then
            echo "âŒ Frontend health check failed after 6 attempts."
            exit 1
          fi
        done
        
        echo "ğŸ‰ All health checks passed!"
      timeout-minutes: 10 